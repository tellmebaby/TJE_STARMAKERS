<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index Page</title>
    <link href="/css/starCard.css" rel="stylesheet" class="css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: rgb(241, 241, 242);
        }
        a {
            text-decoration: none;
            color: black;
        }
    </style>
</head>


    <body layout:fragment="content">
        <div class="container">
                <div class="starList-detail">
                    <div class="items-eventType">
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="eventOngoing">
                            <label for="eventOngoing">진행</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="eventExpired">
                            <label for="eventExpired">종료</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="eventUpcoming">
                            <label for="eventUpcoming">예정</label>
                        </div>
                    </div>
                    <div class="items-category1">
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="instagram">
                            <i class="bi bi-instagram"></i>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="youtube">
                            <i class="bi bi-youtube"></i>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="chzzk">
                            <img src="/img/icon/chzzkLight_logo.gif" alt="치지지로고">
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="afreeca">
                            <img src="/img/icon/afreeca_logo.svg" alt="아프리카로고">
                        </div>
                    </div>
                    <div class="items-category2">
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="food">
                            <label for="food">음식</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="travel">
                            <label for="travel">여행</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="game">
                            <label for="game">게임</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="music">
                            <label for="music">음악</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="animal">
                            <label for="animal">동물</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="workOut">
                            <label for="workOut">운동</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="asmr">
                            <label for="asmr">ASMR</label>
                        </div>
                        <div class="type-sub">
                            <input class="hide-check" type="checkbox" value="" id="fashion">
                            <label for="fashion">패션</label>
                        </div>
                    </div>
                </div>
                <div class="container-starSearch">
                    <div class="sub-searchInput">
                        <i id="icon-inSearchBar" class="bi bi-search"></i>
                        <form id="searchForm">
                            <input type="text" class="search-bar_input" id="searchInput" placeholder="검색" th:value="${param.txt}">
                        </form>
                    </div>
                    <div class="sub-btn-calendar">
                        <a href="starCalendar.html" class="btn-starCalendar"><i class="bi bi-calendar-week"></i></a>
                    </div>
                    <!-- 비로그인시 -->
                    <th:block sec:authorize="isAnonymous()"></th:block>
                    <!-- 로그인시 -->
                    <th:block sec:authorize="isAuthenticated()">
                        <div class="sub-btn-insertCard">
                            <a href="starInsert.html" class="btn-starInsert"><i class="bi bi-pen"></i></a>
                        </div>
                    </th:block>
                </div>

                <div id="promotionCarousel" class="carousel">
                    <div class="row row-cols-2 row-cols-lg-6" id="starList"></div>
                </div>
        </div>


        <script>

            $(document).ready(function () {
                let page = 0;
                const type = 'starCard';
                let isLoading = false;

                function applyStyles() {
                    $('.card-text p span').css({
                        'background-color': '',
                        'color': '',
                        'font-size': '',
                        // 필요한 다른 스타일 속성들도 여기에 추가할 수 있습니다.
                    });
                }

                function loadMoreCards(resetPage = false, keyword = '') {
                    if (isLoading) return;
                    isLoading = true;

                    if (resetPage) page = 0;
                    page += 1;

                    console.log("Loading more cards...");
                    console.log("Page:", page);
                    console.log("Keyword:", keyword);

                    $.ajax({
                        url: `/page/starCard/starList/api`,
                        method: 'GET',
                        data: {
                            type: type,
                            page: page,
                            eventOngoing: $('#eventOngoing').is(':checked'),
                            eventExpired: $('#eventExpired').is(':checked'),
                            eventUpcoming: $('#eventUpcoming').is(':checked'),
                            instagram: $('#instagram').is(':checked'),
                            youtube: $('#youtube').is(':checked'),
                            chzzk: $('#chzzk').is(':checked'),
                            afreeca: $('#afreeca').is(':checked'),
                            food: $('#food').is(':checked'),
                            travel: $('#travel').is(':checked'),
                            game: $('#game').is(':checked'),
                            music: $('#music').is(':checked'),
                            animal: $('#animal').is(':checked'),
                            workOut: $('#workOut').is(':checked'),
                            asmr: $('#asmr').is(':checked'),
                            fashion: $('#fashion').is(':checked'),
                            keyword: keyword
                        },
                        success: function (data) {
                            console.log("Data received:", data);

                            if (resetPage) $('#starList').empty();

                            data.forEach(star => {
                                const categories = star.category1.split(',');
                                const icon1 = categories.includes('afreeca') ? '<img src="/img/icon/afreeca.png" alt="아이콘1" class="content-icon">' : '';
                                const icon2 = categories.includes('chzzk') ? '<img src="/img/icon/chzzk.png" alt="아이콘2" class="content-icon">' : '';
                                const icon3 = categories.includes('youtube') ? '<img src="/img/icon/youtube.png" alt="아이콘3" class="content-icon">' : '';
                                const icon4 = categories.includes('instagram') ? '<img src="/img/icon/instagram.png" alt="아이콘4" class="content-icon">' : '';

                                const categories2 = star.category2.split(',');
                                const musicBtn = categories2.includes('music') ? '<a href="#" class="btn btn-custom" data-category="music">#음악</a>' : '';
                                const travelBtn = categories2.includes('travel') ? '<a href="#" class="btn btn-custom" data-category="travel">#여행</a>' : '';
                                const foodBtn = categories2.includes('food') ? '<a href="#" class="btn btn-custom" data-category="food">#음식</a>' : '';
                                const gameBtn = categories2.includes('game') ? '<a href="#" class="btn btn-custom" data-category="game">#게임</a>' : '';
                                const animalBtn = categories2.includes('animal') ? '<a href="#" class="btn btn-custom" data-category="animal">#동물</a>' : '';
                                const exerciseBtn = categories2.includes('workOut') ? '<a href="#" class="btn btn-custom" data-category="workOut">#운동</a>' : '';
                                const fashionBtn = categories2.includes('fashion') ? '<a href="#" class="btn btn-custom" data-category="fashion">#패션</a>' : '';
                                const asmrBtn = categories2.includes('asmr') ? '<a href="#" class="btn btn-custom" data-category="asmr">#ASMR</a>' : '';

                                const cardHtml = `
                                <div class="col-md-2 mb-4">
                                    <div id="card-effect" class="card ${star.card === '유료홍보' ? 'effect' : ''}" data-no="${star.starNo}">
                                        ${star.card === '유료홍보' ? '<div class="card-overlay"></div>' : ''}
                                        <div class="card ${star.card === '유료홍보' ? 'prime' : 'standard'}" ondblclick="animateCard(this)">
                                            <div class="card custom-card" style="background-image: url('/file/img/${star.imgNo}');">
                                                <span class="star">&#9733;</span>
                                                <div class="top-container">
                                                    <div class="left-content">
                                                        ${icon1}
                                                        ${icon2}
                                                        ${icon3}
                                                        ${icon4}
                                                    </div>
                                                    <div class="right-content">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                                                        </svg>
                                                    </div>
                                                </div> 
                                                <div class="overlay" style="background-image: url('/file/img/${star.imgNo}');"></div>
                                                <div class="card-body">
                                                    <h5 class="card-title">
                                                        <img src="/file/img/${star.userImgId}" alt="작성자 아이콘" class="author-icon">
                                                        ${star.title}
                                                    </h5>
                                                    <div class="card-text">${star.content}</div>
                                                    <div class="bottom-container">
                                                        <div class="field-links">
                                                            ${musicBtn}
                                                            ${travelBtn}
                                                            ${foodBtn}
                                                            ${gameBtn}
                                                            ${animalBtn}
                                                            ${exerciseBtn}
                                                            ${fashionBtn}
                                                            ${asmrBtn}
                                                        </div>
                                                        <div class="star-links">
                                                            <i class="bi bi-star"></i>
                                                            <span class="count">${star.views}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                `;
                                $('#starList').append(cardHtml);
                            });

                            isLoading = false;
                        },
                        error: function () {
                            console.error("Failed to load more cards.");
                            isLoading = false;
                        }
                    });
                }

                // 초기 카드 로드
                loadMoreCards();

                // 스크롤 이벤트
                $(window).scroll(function () {
                    if ($(window).scrollTop() + $(window).height() >= $(document).height()) {
                        loadMoreCards();
                    }
                });

                // 검색 폼 제출 이벤트
                $('#searchForm').submit(function (event) {
                    event.preventDefault();
                    const keyword = $('#searchInput').val();
                    console.log("Search submitted. Keyword:", keyword);
                    loadMoreCards(true, keyword);
                });

                // 체크박스 변경 이벤트
                $('input[type="checkbox"]').change(function () {
                    loadMoreCards(true);
                });

                // 클릭 이벤트
                $('.type-sub').on('click', function () {
                    const checkbox = $(this).find('.hide-check');
                    checkbox.prop('checked', !checkbox.prop('checked'));
                    $(this).toggleClass('checked', checkbox.prop('checked'));
                    // Trigger the change event to ensure the filtering works correctly
                    checkbox.trigger('change');
                });

                // a 태그 클릭 시 체크박스 선택 및 change 이벤트 트리거
                $(document).on('click', '.btn-custom', function(event) {
                    event.stopPropagation(); // 이벤트 전파 중지
                    event.preventDefault();
                    const category = $(this).data('category');
                    const checkbox = $(`#${category}`);

                    if (checkbox.length) {
                        // 체크박스의 상태 변경
                        checkbox.prop('checked', !checkbox.prop('checked'));

                        // 체크박스의 상태에 따라 CSS 클래스 토글
                        if (checkbox.is(':checked')) {
                            console.log(category + "이 체크되었어");
                            checkbox.parent().addClass('checked'); // 체크된 경우 부모 요소에 'checked' 클래스 추가
                        } else {
                            checkbox.parent().removeClass('checked'); // 체크 해제된 경우 부모 요소에서 'checked' 클래스 제거
                        }

                        // Trigger the change event to ensure the filtering works correctly
                        checkbox.trigger('change');
                    }
                });

                // 카드 공유하기 이벤트
                $(document).on({
                    mouseenter: function(event) {
                        var cardNo = $(this).data('no'); // .right-content의 data-no 속성값 가져오기
                        var clipboardIcon = $('<i class="bi bi-clipboard2-plus-fill clipboard-icon"></i>'); // 새로운 클립보드 아이콘 생성
                        $(this).find('.bi-three-dots-vertical').hide(); // 기존 아이콘 숨기기
                        $(this).append(clipboardIcon); // 새로운 클립보드 아이콘 추가
                        clipboardIcon.data('cardNo', cardNo); // 클립보드 아이콘에 cardNo 속성 설정
                    },
                    mouseleave: function() {
                        $('.clipboard-icon').remove(); // 모든 클립보드 아이콘 제거
                        $(this).find('.bi-three-dots-vertical').show(); // 기존 아이콘 다시 보이기
                    }
                }, '.right-content');

                $(document).on('click', '.right-content', function(event) {
                    event.stopPropagation(); // 이벤트 전파 중지
                    var cardNo = $(this).find('.clipboard-icon').data('cardNo'); // 클립보드 아이콘의 cardNo 속성 가져오기
                    var textArea = document.createElement("textarea");
                    textArea.value = 'localHost:8080/page/starCard/starRead?starNo=' + cardNo;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('클립보드에 복사되었습니다.');
                });
            });



        </script>   

    </body>

</html>