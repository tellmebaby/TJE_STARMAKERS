<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{/layout/default_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë²¤íŠ¸</title>
    
<link rel="stylesheet" href="/css/post.css">
</head>
<body>

    <th:block layout:fragment="content">

    <div class="container2">

        

            <center>
                <h1>ì´ë²¤íŠ¸</h1>
                </center>
            
                <div class="writer">
                    <label th:text="${starBoard.writer}"></label>
                    <label th:text="${#dates.format(starBoard.regDate, 'yyyy-MM-dd HH:mm:ss')}" ></label>
                </div>
        
                <div class="title-container">
                    <span th:text="${starBoard.title}"></span>
                    <hr>
                </div>
                <div class="content-container">
                    <span th:utext="${starBoard.content}"></span>
                </div>
            
                <div class="button-wrapper">
                  <div class="button-container1">
                    <button type="button" onclick="moveList()">ëª©ë¡</button>
                  </div>
                  <div class="button-container2">
                    <button type="button" onclick="update()">ìˆ˜ì •</button>
                  </div>
                </div>
            
                <!-- ëŒ“ê¸€ ë“±ë¡ -->
                <div class="reply-container">
                    <div class="reply-box">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                         <!-- ì‚¬ìš©ì ì•„ì´ë””(hidden) -->
                         <input type="hidden" name="writer" id="reply-writer" th:value="${session.user != null ? session.user.id : ''}">
                        <textarea type="text" name="content" id="reply-content" placeholder="ììœ ë¡­ê²Œ ì˜ê²¬ì„ ì‘ì„±í•˜ì„¸ìš”. ìš´ì˜ì›ì¹™ì— ìœ„ë°°ë˜ëŠ” ëŒ“ê¸€ì€ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                    <button type="button" id="btn-reply-insert" class="btn-reply" onclick="insertReply()">ë“±ë¡</button>
                    </div>            
                </div>
                <div class="top-reply-list">
                    <label class="reply">ëŒ“ê¸€</label>
                    <label class="reply-count">ëŒ“ê¸€ ê°¯ìˆ˜</label>
                </div>
                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div id="reply-listbox">
                    
                </div>

     
    </div>

    <script>
    
        let starNo = '[[${starBoard.starNo}]]';

        function moveList() {
          location.href = '/page/board/eventBoard/eventList'
        }
  
        function update() {
          location.href = '/page/board/eventBoard/eventUpdate?starNo=' + starNo
        }

        function toggleRereplyContainer(button) {
            const rereplyContainer = button.parentElement.nextElementSibling;
            console.log(rereplyContainer)
            rereplyContainer.classList.toggle('visible');
        }

        // ëŒ“ê¸€ ëª©ë¡ ìš”ì²­
        replyList()

        // ëŒ“ê¸€ ëª©ë¡
        function replyList() {
            // AJAX ë¹„ë™ê¸° ìš”ì²­
            // ğŸ’ CRSF TOKEN
            let csrfToken = document.querySelector('input[name="_csrf"]').value;
            let request = new XMLHttpRequest()

            // ìš”ì²­ ì„¸íŒ…
            // request.open(ìš”ì²­ë©”ì†Œë“œ, URL)
            request.open('GET', '/page/reply/' + starNo) // ê¸€ ë²ˆí˜¸

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if(request.readyState == request.DONE && request.status == 200) {
                    // ëŒ“ê¸€ ëª©ë¡ í™•ì¸
                    let response = request.responseText
                    // ì„œë²„ì—ì„œ ë Œë”ë§í•œ HTML
                    let data = response
                    let replyList = document.getElementById('reply-listbox')
                    replyList.innerHTML = data

                    event()
                }
            }
            request.send()
        }

        // ëŒ“ê¸€ ë“±ë¡
        function insertReply() {
            let $writer = document.getElementById('reply-writer')
            let $content = document.getElementById('reply-content')

            let writer = $writer.value
            let content = $content.value

            let data = {
                'starNo'    : starNo,
                'writer'    : writer,
                'content'   : content
            }

            console.dir(data)
            // ğŸ’ CRSF TOKEN
            let csrfToken = document.querySelector('input[name="_csrf"]').value;
            let request = new XMLHttpRequest()

            request.open('POST', '/page/reply')
            request.setRequestHeader('Content-Type', 'application/json')
            request.setRequestHeader('X-CSRF-TOKEN', csrfToken)
            request.send(JSON.stringify(data))

            request.onreadystatechange = function() {

                // ìš”ì²­ ì„±ê³µ ì‹œ,
                if(request.readyState == request.DONE && request.status == 201) {
                    console.log('ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ!');
                    let response = request.responseText
                    if(response == 'SUCCESS') {
                        replyList()
                        // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹  í›„ ëŒ“ê¸€ ì…ë ¥ ì°½ ë¹„ìš°ê¸°
                        $writer.value = ''
                        $content.value = ''
                    }
                }
            }
        }

         // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
        document.addEventListener('DOMContentLoaded', function() {
            let isLoggedIn = /*'[[${session.user}]]'*/ null
    
            if (isLoggedIn === null) {
                document.getElementById('reply-content').disabled = true;
                document.getElementById('btn-reply-insert').disabled = true;
                document.getElementById('reply-content').placeholder = "ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
             }
        });

  
      </script>

    
    </th:block>
    
        

</body>
</html>
