<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{/layout/default_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이벤트</title>
    
<link rel="stylesheet" href="/css/post.css">

</head>
<body>

    <th:block layout:fragment="content">

    <div class="container2">

            <center>
                <h1>이벤트</h1>
                </center>
            
                <div class="writer">
                    <label th:text="${starBoard.writer}"></label>
                    <label th:text="${#dates.format(starBoard.regDate, 'yyyy-MM-dd HH:mm:ss')}" ></label>
                </div>
        
                <div class="title-container">
                    <span th:text="${starBoard.title}"></span>
                    <hr>
                </div>
                <div class="content-container">
                    <span th:utext="${starBoard.content}"></span>
                </div>
            
                <div class="button-wrapper">
                  <div class="button-container1">
                    <button type="button" onclick="moveList()">목록</button>
                  </div>
                  <div class="button-container2">
                    <button type="button" onclick="update()">수정</button>
                  </div>
                </div>
            
                <!-- 댓글 등록 -->
                <div class="reply-container">
                    <div class="reply-box">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                         <!-- 사용자 아이디(hidden) -->
                         <input type="hidden" name="writer" id="reply-writer" th:value="${session.user != null ? session.user.id : ''}">
                        <textarea type="text" name="content" id="reply-content" placeholder="자유롭게 의견을 작성하세요. 운영원칙에 위배되는 댓글은 삭제될 수 있습니다."></textarea>
                    <button type="button" id="btn-reply-insert" class="btn-reply" onclick="insertReply()">등록</button>
                    </div>            
                </div>
                <div class="top-reply-list">
                    <label class="reply">댓글</label>
                    <label class="reply-count">댓글 갯수</label>
                </div>
                <!-- 댓글 목록 -->
                <div id="reply-listbox">
                    
                </div>

     
    </div>

    <script>
    
        let starNo = '[[${starBoard.starNo}]]';

        function moveList() {
          location.href = '/page/board/eventBoard/eventList'
        }
  
        function update() {
          location.href = '/page/board/eventBoard/eventUpdate?starNo=' + starNo
        }

        function toggleRereplyContainer(button) {
            const rereplyContainer = button.parentElement.nextElementSibling;
            console.log(rereplyContainer)
            rereplyContainer.classList.toggle('visible');
        }

        // 댓글 목록 요청
        replyList()

        // 댓글 목록
        function replyList() {
            // AJAX 비동기 요청
            // 💍 CRSF TOKEN
            let csrfToken = document.querySelector('input[name="_csrf"]').value;
            let request = new XMLHttpRequest()

            // 요청 세팅
            // request.open(요청메소드, URL)
            request.open('GET', '/page/reply/' + starNo) // 글 번호

            request.onreadystatechange = function() {

                // 요청 성공 시,
                if(request.readyState == request.DONE && request.status == 200) {
                    // 댓글 목록 확인
                    let response = request.responseText
                    // 서버에서 렌더링한 HTML
                    let data = response
                    let replyList = document.getElementById('reply-listbox')
                    replyList.innerHTML = data

                    event()
                }
            }
            request.send()
        }

        // 댓글 등록
        function insertReply() {
            let $writer = document.getElementById('reply-writer')
            let $content = document.getElementById('reply-content')

            let writer = $writer.value
            let content = $content.value

            let data = {
                'starNo'    : starNo,
                'writer'    : writer,
                'content'   : content
            }

            console.dir(data)
            // 💍 CRSF TOKEN
            let csrfToken = document.querySelector('input[name="_csrf"]').value;
            let request = new XMLHttpRequest()

            request.open('POST', '/page/reply')
            request.setRequestHeader('Content-Type', 'application/json')
            request.setRequestHeader('X-CSRF-TOKEN', csrfToken)
            request.send(JSON.stringify(data))

            request.onreadystatechange = function() {

                // 요청 성공 시,
                if(request.readyState == request.DONE && request.status == 201) {
                    console.log('댓글 등록 성공!');
                    let response = request.responseText
                    if(response == 'SUCCESS') {
                        replyList()
                        // 댓글 목록 갱신 후 댓글 입력 창 비우기
                        $writer.value = ''
                        $content.value = ''
                    }
                }
            }
        }

         // 로그인 상태 체크
        document.addEventListener('DOMContentLoaded', function() {
            let isLoggedIn = '[[${session.user}]]'
    
            if (isLoggedIn === null) {
                document.getElementById('reply-content').disabled = true;
                document.getElementById('btn-reply-insert').disabled = true;
                document.getElementById('reply-content').placeholder = "로그인 후 댓글을 작성할 수 있습니다.";
             }
        });

  
      </script>
      <script>
        // 이벤트 등록
        function event() {
            // 댓글 수정 버튼
            let $btnUpdate = document.getElementsByClassName('btn-reply-update')
        
            // 댓글 수정 클릭 이벤트
            for(let i = 0; i < $btnUpdate.length; i++) {
                $btnUpdate[i].addEventListener('click', function() {
                    let $top = $btnUpdate[i].parentNode
                    let writer = $top.childNodes[1].textContent
                    let $inner = $top.parentNode
                    let content = $inner.childNodes[1].textContent
                    let $replyBox = $inner.parentNode


                    let replyNo = $btnUpdate[i].getAttribute('data') // 댓글 번호

                    // 댓글 수정 모드
                    // 1. 기존 댓글 내용창 숨기기
                    $inner.style.display = 'none';
                    // 2. 수정 UI 출력
                    let $editor = document.createElement('div')
                    $editor.classList.add('inner');
                    $editor.id = 'editor'
                    let editor = `
                            <input type="hidden" id="update-writer" value="${writer}">
                            <textarea id="update-reply" >${content}</textarea>
                            <div class="reply-button">
                                <button class="btn-reply-update" onclick="updateReply(${replyNo})">수정</button>
                                <button class="btn-reply-delete" onclick="cancelReply(${replyNo})">취소</button>
                            </div>
                        `;
        
                    $editor.innerHTML = editor
                    $replyBox.appendChild($editor)

                })
            }
        }

        // 댓글 수정 요청
        function updateReply(replyNo) {
            // alert('댓글 수정')
            let writer = document.getElementById('update-writer').value
            let content = document.getElementById('update-reply').value
            // let content = "되라좀";

            console.log(`수정한 작성자 : ${writer}`)
            console.log(`수정한 내용 :  ${content}`)


            let data = {
                'replyNo'   : replyNo,
                'writer'    : writer,
                'content'   : content
            }

            console.dir(data)

            // 수정 요청
            let csrfToken = document.querySelector('input[name="_csrf"]').value;
            let request = new XMLHttpRequest()
            request.open('PUT', '/page/reply')
            request.setRequestHeader('Content-Type', 'application/json')
            request.setRequestHeader('X-CSRF-TOKEN', csrfToken)
            request.send(JSON.stringify(data))

            request.onreadystatechange = function() {
                // 요청 성공 시,
                if(request.readyState == request.DONE && request.status == 200) {
                    console.log('댓글 수정 성공!');
                    let response = request.responseText
                    alert(response)
                    if(response == 'SUCCESS') {
                        replyList() // 댓글 목록 갱신
                    }
                }
            }
        }

        // 댓글 수정 취소
        function cancelReply() {
            const check = confirm("작성중인 내용이 사라집니다.")
            if(!check)
                return

            let $editor = document.getElementById('editor')
            $editor.remove()

            let $inner = document.getElementsByClassName('inner')
            for (let i = 0; i < $inner.length; i++) {
                $inner[i].style.display = 'block'
                
            }
        }

        // 댓글 삭제
        function deleteReply(replyNo) {

            const check = confirm("정말로 삭제하시겠습니까?")
            if(!check)
                return
            let csrfToken = document.querySelector('input[name="_csrf"]').value;
            let request = new XMLHttpRequest();

            request.open('DELETE', `/page/reply/${replyNo}`);
            request.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            request.send();

            request.onreadystatechange = function() {
                if (request.readyState == request.DONE && request.status == 200) {
                    let response = request.responseText
                    if (request.responseText == 'SUCCESS') {
                        replyList();
                    }
                }
            }
        }


        // 답글 등록
        function insertAnswer(element, replyNo) {
            let $replyBox = element.parentNode.parentNode
            console.log(`부모 번호 : ${replyNo}`);
            console.log($replyBox);

            // 답글 작성 UI
            let $editor = document.createElement('div')
            $editor.classList.add('rereply-list')
            $editor.id = 'answer'
            // <div id="answer" class="reply-box">
            let editor = ``
            editor += `<div id="rereply-list">
                <div class="rereply" th:each="reply : ${rereplyList}">
                    <!-- 답글 -->
                    <div class="rereply-top">
                        <span class="rereply-writer" th:text="${reply.writer}"></span>
                        <span class="rereply-regDate" th:text="${reply.regDate}">
                            <i class="fa-regular fa-thumbs-up icon"></i>
                        </span>
                    </div>
                    <!-- 답글 내용/ 수정 삭제 버튼 -->
                    <div class="rereply-middle">
                        <p class="rereply-content" th:text="${reply.content}"></p>
                        <div class="rereply-button">
                            <button class="btn-rereply-update">수정</button>
                            <button class="btn-rereply-delete">삭제</button>
                        </div>
                    </div>
                    <!-- 답글에 답글 쓰기 -->
                    <div class="rereply-rereply">
                        <button class="btn-rereply" onclick="toggleRereplyContainer(this)">답글쓰기</button>
                    </div>
                    <div class="rereply-container m-0 p-0">
                        <div class="rereply-box">
                            <textarea type="text" placeholder="자유롭게 의견을 작성하세요. 운영원칙에 위배되는 댓글은 삭제될 수 있습니다."></textarea>
                            <button type="button" >등록</button>
                        </div>       
                    </div>
                </div>
            </div>`
            $editor.innerHTML = editor

            // 기존 답글 UI 가 있으면 초기화
            let $answer = document.getElementById("answer");
            if($answer) {
                $answer.parentNode.removeChild($answer);
            }

            // 요소.after(추가 요소)
            // - 요소 바로 뒤에 새 요소를 추가한다.
            $replyBox.after($editor)
        }

        // 답글 등록 요청
        function answer(parentNo) {
            // TODO:
            // 1. answer-writer, answer-content 값을 가져오고
            // 2. data = {부모번호, 작성자, 내용}
            // 3. POST = /reply 요청
            let $writer = document.getElementById('rereply-writer')
            let $content = document.getElementById('rereply-content')

            let writer = $writer.value
            let content = $content.value


            let data = {
                'replyNo'   : replyNo,       // 글 번호
                'parentNo'  : parentNo, // 부모 댓글 번호
                'writer'    : writer,
                'content'   : content
            }

            console.dir(data)
            let csrfToken = document.querySelector('input[name="_csrf"]').value;
            let request = new XMLHttpRequest()

            request.open('POST', '/page/reply')
            request.setRequestHeader('Content-Type', 'application/json')
            request.setRequestHeader('X-CSRF-TOKEN', csrfToken);
            request.send(JSON.stringify(data))

            request.onreadystatechange = function() {

                // 요청 성공 시,
                if(request.readyState == request.DONE && request.status == 201) {
                    console.log('답글 등록 성공!');
                    let response = request.responseText
                    if(response == 'SUCCESS') {
                        replyList() // 댓글 목록 갱신
                    }
                }
            }
        }

      </script>

    
    </th:block>
    
        

</body>
</html>
